# Copyright (c) 2018 Alec Leamas
#
# This program is free software; you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation; either version 2 of the License, or
# (at your option) any later version.
#

# This manifest is used to build the official flathub package.


app-id: org.opencpn.OpenCPN
runtime: org.freedesktop.Platform
runtime-version: "20.08"
sdk: org.freedesktop.Sdk
command: opencpn.sh

rename-desktop-file: opencpn.desktop
rename-icon: opencpn
rename-appdata-file: opencpn.appdata.xml

finish-args:
    - --socket=x11
    - --socket=pulseaudio
    - --filesystem=home
    - --share=network
    - --device=all

add-extensions:
    org.opencpn.OpenCPN.Plugin:
        directory: extensions
        merge-dirs: lib/opencpn;share/opencpn/plugins;share/locale
        subdirectories: true
        no-autodownload: true
        autodelete: false

modules:
    - shared-modules/glu/glu-9.json

    - name: libusb
      config-opts:
        - --disable-static
        - --disable-udev
        - --prefix=/app
      sources:
        - type: archive
          url: https://github.com/libusb/libusb/archive/v1.0.22.tar.gz
          sha256: 3500f7b182750cd9ccf9be8b1df998f83df56a39ab264976bdb3307773e16f48

    - name: wxGTK3
      sources:
          - type: archive
            url: https://github.com/wxWidgets/wxWidgets/releases/download/v3.1.5/wxWidgets-3.1.5.tar.bz2
            sha256: d7b3666de33aa5c10ea41bb9405c40326e1aeb74ee725bb88f90f1d50270a224
          - type: patch
            path: 0100-doxyfile-update.patch
          - type: patch
            path: 0101-Fix-missing-mouse-events-when-using-gesture-events.patch
          - type: patch
            path: 0102-warn-for-compiler-abi-mismatch.patch
          - type: patch
            path: 0103-Fix-wxGTK-build-after-WXSetInitialFittingClientSize.patch
          - type: patch
            path: 0104-Make-wxSizer-SetSizeHints-work-again.patch
      config-opts:
          - --with-gtk=3
          - --with-opengl
          - --with-sdl
          - --with-libmspack
          - --enable-intl
          - --disable-rpath
          - --enable-ipv6
      cleanup:
          - /include/

    - name:  zlib
      sources:
          - type: archive
            url: http://zlib.net/zlib-1.2.11.tar.gz
            sha256: c3e5e9fdd5004dcb542feda5ee4f0ff0744628baf8ed2dd5d66f8ca1197cb1a1

    - name: portaudio
      config-opts:
          - --disable-static
          - --without-oss
          - --without-jack
      sources:
          - type: archive
            url: http://www.portaudio.com/archives/pa_stable_v190600_20161030.tgz
            sha256: f5a21d7dcd6ee84397446fa1fa1a0675bb2e8a4a6dceb4305a8404698d8d1513
      cleanup:
          - /lib/pkgconfig
          - /include
          - '*.la'

    - name: opencpn
      buildsystem: cmake
      builddir: true
      config-opts:
          - -DOCPN_RELEASE=3.wx315
          - -DOCPN_BUNDLE_DOCS=ON
          - -DOCPN_BUNDLE_TCDATA=ON
          - -DOCPN_CI_BUILD=ON
          - -DOCPN_FLATPAK=ON
          - -DOCPN_ENABLE_SYSTEM_CMD_SOUND=OFF
          - -DOCPN_USE_SYSFS_PORTS=ON
          - -DBUILD_SHARED_LIBS=OFF
          - -DCMAKE_FIND_ROOT_PATH=/app
          - -DCMAKE_FIND_ROOT_PATH_MODE_PROGRAM=NEVER
          - -DCMAKE_FIND_ROOT_PATH_MODE_LIBRARY=BOTH
          - -DCMAKE_FIND_ROOT_PATH_MODE_INCLUDE=BOTH
          - arch:
              - x86_64:
                  - -DOCPN_TARGET_TUPLE=flatpak-x86_64-wx315;20.08;x86_64
              - aarch64:
                  - -DOCPN_TARGET_TUPLE=flatpak-aarch64-wx315;20.08;x86_64

      build-options:
          cxxflags: -DFLATPAK
          cflags: -DFLATPAK
          env:
            BUILD_NUMBER: "0"
      post-install:
          - install -d /app/extensions
          - sed -i '/^Exec=/s/=.*/=opencpn.sh/' /app/share/applications/opencpn.desktop
          - install -Dm 755 ../data/opencpn.sh /app/bin/opencpn.sh
      sources:
          - type: git
            url: https://github.com/OpenCPN/OpenCPN.git
            tag: Beta_5.6.1_1
            disable-fsckobjects: true
          - type: patch
            paths:
              - 0002-flatpak-Add-a-shell-wrapper.patch
              - 0004-CMakeLists-Add-a-OCPN_RELEASE-option.patch
              - 0005-Add-wx315-to-target-ABI-specification.patch
