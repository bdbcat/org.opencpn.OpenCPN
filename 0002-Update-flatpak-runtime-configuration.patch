From be24bf90c4f28ece66e6083b5256ee72e4f4de52 Mon Sep 17 00:00:00 2001
From: Alec Leamas <leamas.alec@nowhere.nt>
Date: Sat, 13 Mar 2021 10:02:50 +0100
Subject: [PATCH 2/5] Update flatpak runtime configuration.

---
 cmake/TargetSetup.cmake          | 10 +++++++++-
 flatpak/org.opencpn.OpenCPN.yaml |  2 +-
 2 files changed, 10 insertions(+), 2 deletions(-)

diff --git a/cmake/TargetSetup.cmake b/cmake/TargetSetup.cmake
index b394af04c..e83466c9f 100644
--- a/cmake/TargetSetup.cmake
+++ b/cmake/TargetSetup.cmake
@@ -4,7 +4,15 @@
 
 if (OCPN_FLATPAK)
     set(PKG_TARGET "flatpak")
-    set(PKG_TARGET_VERSION "18.08")    # As of flatpak/*yaml
+    set(manifest_path "${PROJECT_SOURCE_DIR}/flatpak/org.opencpn.OpenCPN.yaml")
+    file(READ ${manifest_path} manifest)
+    string(REPLACE "\n" ";" manifest_lines "${manifest}")
+    foreach (_line ${manifest_lines})
+      if (${_line} MATCHES  "^runtime-version")
+        string(REGEX REPLACE ".*:" "" PKG_TARGET_VERSION "${_line}")
+      endif ()
+    endforeach ()
+    message(STATUS  "Building for flatpak runtime ${PKG_TARGET_VERSION}")
 elseif (MINGW)
     set(PKG_TARGET "mingw")
     if (CMAKE_SYSTEM_VERSION)
diff --git a/flatpak/org.opencpn.OpenCPN.yaml b/flatpak/org.opencpn.OpenCPN.yaml
index 97a9fbb91..2d40d8696 100644
--- a/flatpak/org.opencpn.OpenCPN.yaml
+++ b/flatpak/org.opencpn.OpenCPN.yaml
@@ -12,7 +12,7 @@
 
 app-id: org.opencpn.OpenCPN
 runtime: org.freedesktop.Platform
-runtime-version: 18.08
+runtime-version: 20.08
 sdk: org.freedesktop.Sdk
 command: opencpn.sh
 
-- 
2.29.2

